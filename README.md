# DCMT on Horizon X3 pi

This is an official X3 pi deployment of DCMT[1] based on Python, whose architectures include three version:
* DCMT_al: a UAV tracker, whose backbone is AlexNet
* DCMT_lt: a speed-oriented tracker, whose backbone is the same as LightTrack mobile version
* DCMT_res: an accuracy-oriented tracker, whose backbone is ResNet50

## Model Overview
Tracker | MACs | Params | FPS | Avg Latency | DDR Latency | Subgraph | BPU Util1 | BPU Util2 | UAV10FPS Success | GOT10KTEST Success
--- | --- | --- | --- |--- |--- |--- |--- |--- |--- |---
DCMT_al | 10.80G | 11.54M | 17.27 | 229.54ms | 646.89ms | 13 | - | - | 0.611 | -
DCMT_lt | 2.90G | 12.29M | 17.62 | 225.72ms | 666.83ms | 14 | - | - | - | 0.636
DCMT_res | 27.85G | 26.53M | 8.34 | 476.54ms | 1294.12ms | 15 | - | - | - | 0.664

We test BPU utilization rate by using hrut_somstatus while testing static performance with 4 threads:
```
hrut_somstatus -n 10000 -d 1
```
We record the outputs of hrut_somstatus, delete the values which are lower than 10% 
and compute the average of BPU utilization rate.  
Note that in order to ensure fairness when compared with other trackers, 
we do not execute any optimization of operators when deploying model on Horizon X3 pi.

## Demos for ChasingDrones
```
cd video
tar zxvf ChasingDrones.tar.gz
```
### DCMT_al runs ChasingDrones
<div align="center">
  <img src="https://github.com/STQ-AmadeusUser/DCMT-X3/blob/main/images/ChasingDrones_al_result.gif">
</div>

### DCMT_lt runs ChasingDrones
<div align="center">
  <img src="https://github.com/STQ-AmadeusUser/DCMT-X3/blob/main/images/ChasingDrones_lt_result.gif">
</div>

### DCMT_res runs ChasingDrones
<div align="center">
  <img src="https://github.com/STQ-AmadeusUser/DCMT-X3/blob/main/images/ChasingDrones_res_result.gif">
</div>

The GIFs are generated by using moviepy to covert ChasingDrones_{al/lt/res}_result.mp4, which the demo on X3 pi outputs:

```
from moviepy.editor import *
clip = (VideoFileClip("ChasingDrones_lt_result.mp4").resize((640, 360)))
clip.write_gif("ChasingDrones_lt_result.gif", fps=15)
```

### A Demo on X3 pi
You can execute running_on_X3.py to experience DCMT on ChasingDrones, one video in DTB70[2] benchmark:
```
cd tracking
python running_on_X3.py --arch_type lt
```
The param "arch_type" will decide which type of DCMT you run:
"al" means you run DCMT_al; 
"lt" means you run DCMT_lt; 
"res" means you run DCMT_res.
The code will generate a video named ChasingDrones_{al/lt/res}_result.mp4 in "video" directory.

### A Demo on Laptop
We also provide demo.py for laptop running (PyTorch required):
```
cd tracking
python demo.py --arch_type lt
```
The code will also generate a video named ChasingDrones_{al/lt/res}_result.mp4 in "video" directory.

## How to Deploy (for developers)
We have converted the network of DCMT_{al/lt/res} to DCMT_{al/lt/res}.bin, a file with X3-pi-specialized format, in "bin" directory.  
If you want to generate the file by yourself, you can take advantage of our code and [follow this instruction](https://developer.horizon.cc/documents_rdk/category/toolchain_development).
1. Get the onnx model: DCMT_lt.onnx
```
cd deploy
python convert_onnx.py --arch_type lt
```
You can visualize onnx model by using [netron](https://netron.app/).

2. Simplify onnx model: HiFT_sim.onnx
```
python -m onnxsim DCMT_lt.onnx DCMT_lt_sim.onnx
```
3. Generate files for calibration:
```
python calibration.py
```
This step requires training datasets described in official implementation of DCMT or pysot[3].
If you do not want to prepare datasets, we also provide calibration files in calibration_{al/lt/res}.tar.gz.

4. Convert onnx model: DCMT_lt.bin
```
hb_mapper makertbin --config DCMT_lt.yaml --model-type onnx
```
This step needs Horizon AI Tool-chain. We create an anaconda environment for python packages 
as mentioned in [here](https://developer.horizon.cc/documents_rdk/toolchain_development/beginner).
Note that we do not use docker image. DCMT_lt.yaml contains all parameters used in conversion.

5. Log file is "deploy/hb_mapper_makertbin_{al/lt/res}.log".
6. Other generated files are in "deploy/model" directory.

## Static Performance
We provide static performance of DCMT by running on X3 pi:
1. 1 thread of DCMT_al:
```
hrt_model_exec perf --model_file DCMT_al.bin --thread_num 1
```
<div align="center">
  <img src="https://github.com/STQ-AmadeusUser/DCMT-X3/blob/main/images/1_thread_al.png">
</div>

2. 4 thread of DCMT_al:
```
hrt_model_exec perf --model_file DCMT_al.bin --thread_num 4
```
<div align="center">
  <img src="https://github.com/STQ-AmadeusUser/DCMT-X3/blob/main/images/4_thread_al.png">
</div>

3. 1 thread of DCMT_lt:
```
hrt_model_exec perf --model_file DCMT_lt.bin --thread_num 1
```
<div align="center">
  <img src="https://github.com/STQ-AmadeusUser/DCMT-X3/blob/main/images/1_thread_lt.png">
</div>

4. 4 thread of DCMT_lt:
```
hrt_model_exec perf --model_file DCMT_lt.bin --thread_num 4
```
<div align="center">
  <img src="https://github.com/STQ-AmadeusUser/DCMT-X3/blob/main/images/4_thread_lt.png">
</div>

5. 1 thread of DCMT_res:
```
hrt_model_exec perf --model_file DCMT_res.bin --thread_num 1
```
<div align="center">
  <img src="https://github.com/STQ-AmadeusUser/DCMT-X3/blob/main/images/1_thread_res.png">
</div>

6. 4 thread of DCMT_res:
```
hrt_model_exec perf --model_file DCMT_res.bin --thread_num 4
```
<div align="center">
  <img src="https://github.com/STQ-AmadeusUser/DCMT-X3/blob/main/images/4_thread_res.png">
</div>

## Version
1. System on X3 pi: [ubuntu-preinstalled-server-arm64.img.xz](http://sunrise.horizon.cc/downloads/os_images/2.0.0/release/) 
   (2.0.0)
2. Horizon AI Tool-chain:
    ```
    wget -c ftp://xj3ftp@vrftp.horizon.ai/ai_toolchain/ai_toolchain.tar.gz --ftp-password=xj3ftp@123$%
    ```
    1. hbdk-3.48.6-cp38-cp38-linux_x86_64.whl
    2. hbdk_model_verifier-3.48.6-py3-none-linux_x86_64.whl
    3. horizon_nn-0.21.2-cp38-cp38-linux_x86_64.whl
    4. horizon_tc_ui-1.21.6-cp38-cp38-linux_x86_64.whl
3. [OE package](https://developer.horizon.ai/forumDetail/136488103547258769): horizon_xj3_open_explorer_v2.6.2b-py38_20230606
    ```
    wget -c ftp://vrftp.horizon.ai/Open_Explorer_gcc_9.3.0/2.6.2b/horizon_xj3_open_explorer_v2.6.2b-py38_20230606.tar.gz
    ```
4. PyTorch:
    1. for convert_onnx.py: torch-1.8.0+cu111-cp37-cp37m-linux_x86_64.whl
    2. for demo on laptop: torch-1.9.0+cu111-cp37-cp37m-linux_x86_64.whl

## Reference
[1] DCMT: https://github.com/STQ-AmadeusUser/DCMT  
[2] DTB70: https://github.com/flyers/drone-tracking  
[3] PySOT: https://github.com/STVIR/pysot
